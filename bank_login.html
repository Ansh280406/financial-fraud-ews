<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Bank - Secure Login</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); height: 100vh; display: flex; justify-content: center; align-items: center; margin: 0; }
        .login-card { background: white; padding: 2.5rem; border-radius: 10px; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center; }
        h2 { color: #2c3e50; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.3s; }
        button:hover { background: #0056b3; }
        .status { margin-top: 15px; font-size: 0.9rem; font-weight: bold; min-height: 20px; }
        .logo { font-size: 3rem; margin-bottom: 10px; }
        .hint { font-size: 0.75rem; color: #888; margin-top: 10px; text-align: left; background: #f8f9fa; padding: 8px; border-radius: 4px; border: 1px dashed #ccc; }
    </style>
</head>
<body>

    <div class="login-card">
        <div class="logo">üè¶</div>
        <h2>Global Bank</h2>
        <input type="text" id="username" placeholder="Username" value="demo_user">
        
        <!-- Smart Password Input -->
        <input type="text" id="password" placeholder="Password" value="password123" oninput="handlePasswordInput(this)">
        
        <button onclick="attemptLogin()">Log In</button>
        <div id="status" class="status"></div>

        <div class="hint">
            <strong>Demo Credentials:</strong><br>
            ‚Ä¢ demo_user / password123<br>
            ‚Ä¢ demo_travel / travel123<br>
            ‚Ä¢ demo_otp / bot123<br>
            ‚Ä¢ demo_impersonation / hacker123
        </div>
    </div>

    <script>
        // Password "Show Last Character" Logic
        let realPassword = "password123"; 
        let maskingTimer;

        function handlePasswordInput(input) {
            const val = input.value;
            // Handle backspace/delete
            if (val.length < realPassword.length) {
                realPassword = realPassword.substring(0, val.length);
                return;
            }
            // Get the new character typed
            const newChar = val.slice(-1);
            realPassword += newChar;

            // Show character briefly
            clearTimeout(maskingTimer);
            input.value = "‚Ä¢".repeat(realPassword.length - 1) + newChar;

            // Mask after 800ms
            maskingTimer = setTimeout(() => {
                input.value = "‚Ä¢".repeat(realPassword.length);
            }, 800);
        }

        // Initialize masking on load (if value exists)
        window.onload = function() {
            const pwdInput = document.getElementById('password');
            if(pwdInput.value) {
                pwdInput.value = "‚Ä¢".repeat(realPassword.length);
            }
        }

        async function attemptLogin() {
            const statusEl = document.getElementById('status');
            statusEl.innerText = "Analyzing Risk...";
            statusEl.style.color = "blue";

            // --- DEBUG: Check for HTTPS/Mixed Content Issue ---
            // If you run this in the AI chat preview (HTTPS), it cannot talk to Localhost (HTTP).
            if (window.location.protocol === 'https:') {
                alert("‚ö†Ô∏è ERROR: You cannot run this in the online preview!\n\nPlease open the 'bank_login.html' file directly from your computer folder.");
                statusEl.innerText = "‚ùå Run this file locally, not in browser preview.";
                statusEl.style.color = "red";
                return;
            }

            try {
                const userId = document.getElementById('username').value;
                
                // --- LOGIC: Determine scenario based on username ---
                let scenario = "normal_login";
                if(userId.includes("travel")) scenario = "impossible_travel";
                if(userId.includes("otp")) scenario = "otp_attack";
                if(userId.includes("impersonation")) scenario = "impersonation";

                const payload = {
                    user_id: userId,
                    password: realPassword, // Send the REAL password variable
                    ip_address: "192.168.1.5", 
                    device_fingerprint: "chrome_win10",
                };

                // --- CRITICAL FIX: Append the scenario to the URL ---
                const response = await fetch(`http://127.0.0.1:8000/assess-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) { 
                    throw new Error("Server Error: " + response.status); 
                }

                const data = await response.json();

                // React to the decision
                if (data.security_action.includes("Allow")) {
                    statusEl.innerText = "‚úÖ Login Successful!";
                    statusEl.style.color = "green";
                } else if (data.security_action.includes("Block")) {
                    // Show specific reason (Auth Failure or Risk Block)
                    if (data.risk_level === "Auth Failure") {
                        statusEl.innerText = "‚õî Login Failed: Invalid Credentials";
                    } else {
                        statusEl.innerText = "‚õî BLOCKED: Unusual Activity Detected";
                    }
                    statusEl.style.color = "red";
                } else {
                    statusEl.innerText = "‚ö†Ô∏è Verify: Check your email.";
                    statusEl.style.color = "orange";
                }

            } catch (error) {
                statusEl.innerText = "‚ùå Connection Failed.";
                statusEl.style.color = "red";
                console.error(error);
                alert("Could not connect to Python Server!\n\n1. Check if the black command window is open.\n2. Ensure 'uvicorn main:app --reload' is running.\n3. Ensure you opened this HTML file from your folder, NOT the online preview.");
            }
        }
    </script>
</body>
</html>
